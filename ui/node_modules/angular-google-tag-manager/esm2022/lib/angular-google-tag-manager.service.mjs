import { Inject, Injectable, Optional } from '@angular/core';
import { GoogleTagManagerConfiguration } from './angular-google-tag-manager-config.service';
import * as i0 from "@angular/core";
import * as i1 from "./angular-google-tag-manager-config.service";
export class GoogleTagManagerService {
    constructor(googleTagManagerConfiguration, googleTagManagerId, googleTagManagerMode = "noisy", googleTagManagerAuth, googleTagManagerPreview, googleTagManagerResourcePath, googleTagManagerCSPNonce) {
        this.googleTagManagerConfiguration = googleTagManagerConfiguration;
        this.googleTagManagerId = googleTagManagerId;
        this.googleTagManagerMode = googleTagManagerMode;
        this.googleTagManagerAuth = googleTagManagerAuth;
        this.googleTagManagerPreview = googleTagManagerPreview;
        this.googleTagManagerResourcePath = googleTagManagerResourcePath;
        this.googleTagManagerCSPNonce = googleTagManagerCSPNonce;
        this.isLoaded = false;
        this.browserGlobals = {
            windowRef() {
                return window;
            },
            documentRef() {
                return document;
            },
        };
        this.config = this.googleTagManagerConfiguration?.get();
        if (this.config == null) {
            this.config = { id: null };
        }
        this.config = {
            ...this.config,
            id: googleTagManagerId || this.config.id,
            gtm_auth: googleTagManagerAuth || this.config.gtm_auth,
            gtm_preview: googleTagManagerPreview || this.config.gtm_preview,
            gtm_resource_path: googleTagManagerResourcePath || this.config.gtm_resource_path,
        };
        if (this.config.id == null) {
            return;
        }
    }
    checkForId() {
        if (this.googleTagManagerMode !== "silent" && !this.config.id) {
            throw new Error('Google tag manager ID not provided.');
        }
        else if (!this.config.id) {
            return false;
        }
        return true;
    }
    getDataLayer() {
        this.checkForId();
        const window = this.browserGlobals.windowRef();
        window.dataLayer = window.dataLayer || [];
        return window.dataLayer;
    }
    pushOnDataLayer(obj) {
        this.checkForId();
        const dataLayer = this.getDataLayer();
        dataLayer.push(obj);
    }
    addGtmToDom() {
        return new Promise((resolve, reject) => {
            if (this.isLoaded) {
                return resolve(this.isLoaded);
            }
            else if (!this.checkForId()) {
                return resolve(false);
            }
            const doc = this.browserGlobals.documentRef();
            this.pushOnDataLayer({
                'gtm.start': new Date().getTime(),
                event: 'gtm.js',
            });
            const gtmScript = doc.createElement('script');
            gtmScript.id = 'GTMscript';
            gtmScript.async = true;
            gtmScript.src = this.applyGtmQueryParams(this.config.gtm_resource_path
                ? this.config.gtm_resource_path
                : 'https://www.googletagmanager.com/gtm.js');
            gtmScript.addEventListener('load', () => {
                return resolve((this.isLoaded = true));
            });
            gtmScript.addEventListener('error', () => {
                return reject(false);
            });
            if (this.googleTagManagerCSPNonce) {
                gtmScript.setAttribute('nonce', this.googleTagManagerCSPNonce);
            }
            doc.head.insertBefore(gtmScript, doc.head.firstChild);
        });
    }
    pushTag(item) {
        return new Promise((resolve, reject) => {
            if (!this.checkForId()) {
                return resolve();
            }
            if (!this.isLoaded) {
                this.addGtmToDom()
                    .then(() => {
                    this.pushOnDataLayer(item);
                    return resolve();
                })
                    .catch(() => reject());
            }
            else {
                this.pushOnDataLayer(item);
                return resolve();
            }
        });
    }
    applyGtmQueryParams(url) {
        if (url.indexOf('?') === -1) {
            url += '?';
        }
        return (url +
            Object.keys(this.config)
                .filter((k) => this.config[k])
                .map((k) => `${k}=${this.config[k]}`)
                .join('&'));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: GoogleTagManagerService, deps: [{ token: GoogleTagManagerConfiguration, optional: true }, { token: 'googleTagManagerId', optional: true }, { token: 'googleTagManagerMode', optional: true }, { token: 'googleTagManagerAuth', optional: true }, { token: 'googleTagManagerPreview', optional: true }, { token: 'googleTagManagerResourcePath', optional: true }, { token: 'googleTagManagerCSPNonce', optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: GoogleTagManagerService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.5", ngImport: i0, type: GoogleTagManagerService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.GoogleTagManagerConfiguration, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [GoogleTagManagerConfiguration]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerId']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerMode']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerAuth']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerPreview']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerResourcePath']
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: ['googleTagManagerCSPNonce']
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItZ29vZ2xlLXRhZy1tYW5hZ2VyL3NyYy9saWIvYW5ndWxhci1nb29nbGUtdGFnLW1hbmFnZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sNkNBQTZDLENBQUM7OztBQU01RixNQUFNLE9BQU8sdUJBQXVCO0lBYWxDLFlBR1MsNkJBQTRELEVBQ2xCLGtCQUEwQixFQUN4Qix1QkFBeUMsT0FBTyxFQUc1RixvQkFBNEIsRUFHNUIsdUJBQStCLEVBRy9CLDRCQUFvQyxFQUdwQyx3QkFBZ0M7UUFkaEMsa0NBQTZCLEdBQTdCLDZCQUE2QixDQUErQjtRQUNsQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQVE7UUFDeEIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUE0QjtRQUc1Rix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQVE7UUFHNUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFRO1FBRy9CLGlDQUE0QixHQUE1Qiw0QkFBNEIsQ0FBUTtRQUdwQyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQVE7UUE3QmpDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFHakIsbUJBQWMsR0FBRztZQUN2QixTQUFTO2dCQUNQLE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUM7WUFDRCxXQUFXO2dCQUNULE9BQU8sUUFBUSxDQUFDO1lBQ2xCLENBQUM7U0FDRixDQUFDO1FBcUJBLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ3hELElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUU7WUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQztTQUM1QjtRQUVELElBQUksQ0FBQyxNQUFNLEdBQUc7WUFDWixHQUFHLElBQUksQ0FBQyxNQUFNO1lBQ2QsRUFBRSxFQUFFLGtCQUFrQixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4QyxRQUFRLEVBQUUsb0JBQW9CLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQ3RELFdBQVcsRUFBRSx1QkFBdUIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVc7WUFDL0QsaUJBQWlCLEVBQ2YsNEJBQTRCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUI7U0FDaEUsQ0FBQztRQUNGLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQzFCLE9BQU87U0FDUjtJQUNILENBQUM7SUFFTyxVQUFVO1FBQ2hCLElBQUksSUFBSSxDQUFDLG9CQUFvQixLQUFLLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFHO1lBQzlELE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUN4RDthQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRztZQUMzQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sWUFBWTtRQUNqQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMvQyxNQUFNLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO1FBQzFDLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRU8sZUFBZSxDQUFDLEdBQVc7UUFDakMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTSxXQUFXO1FBQ2hCLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNqQixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDL0I7aUJBQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsRUFBRztnQkFDOUIsT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDdkI7WUFDRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzlDLElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ25CLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRTtnQkFDakMsS0FBSyxFQUFFLFFBQVE7YUFDaEIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxTQUFTLENBQUMsRUFBRSxHQUFHLFdBQVcsQ0FBQztZQUMzQixTQUFTLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztZQUN2QixTQUFTLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUI7Z0JBQzNCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQjtnQkFDL0IsQ0FBQyxDQUFDLHlDQUF5QyxDQUM5QyxDQUFDO1lBQ0YsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUU7Z0JBQ3RDLE9BQU8sT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUU7Z0JBQ3ZDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxJQUFJLENBQUMsd0JBQXdCLEVBQUU7Z0JBQ2pDLFNBQVMsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO2FBQ2hFO1lBQ0QsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDeEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sT0FBTyxDQUFDLElBQVk7UUFDekIsT0FBTyxJQUFJLE9BQU8sQ0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFHO2dCQUN2QixPQUFPLE9BQU8sRUFBRSxDQUFDO2FBQ2xCO1lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxXQUFXLEVBQUU7cUJBQ2YsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDVCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUMzQixPQUFPLE9BQU8sRUFBRSxDQUFDO2dCQUNuQixDQUFDLENBQUM7cUJBQ0QsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDM0IsT0FBTyxPQUFPLEVBQUUsQ0FBQzthQUNsQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLG1CQUFtQixDQUFDLEdBQVc7UUFDckMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQzNCLEdBQUcsSUFBSSxHQUFHLENBQUM7U0FDWjtRQUVELE9BQU8sQ0FDTCxHQUFHO1lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO2lCQUNyQixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQzdCLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2lCQUNwQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQ2IsQ0FBQztJQUNKLENBQUM7OEdBMUlVLHVCQUF1QixrQkFleEIsNkJBQTZCLDZCQUVqQixvQkFBb0IsNkJBQ3BCLHNCQUFzQiw2QkFFbEMsc0JBQXNCLDZCQUd0Qix5QkFBeUIsNkJBR3pCLDhCQUE4Qiw2QkFHOUIsMEJBQTBCO2tIQTdCekIsdUJBQXVCLGNBRnRCLE1BQU07OzJGQUVQLHVCQUF1QjtrQkFIbkMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQWVJLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsNkJBQTZCOzswQkFFcEMsUUFBUTs7MEJBQUksTUFBTTsyQkFBQyxvQkFBb0I7OzBCQUN2QyxRQUFROzswQkFBSSxNQUFNOzJCQUFDLHNCQUFzQjs7MEJBQ3pDLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsc0JBQXNCOzswQkFFN0IsUUFBUTs7MEJBQ1IsTUFBTTsyQkFBQyx5QkFBeUI7OzBCQUVoQyxRQUFROzswQkFDUixNQUFNOzJCQUFDLDhCQUE4Qjs7MEJBRXJDLFFBQVE7OzBCQUNSLE1BQU07MkJBQUMsMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgR29vZ2xlVGFnTWFuYWdlckNvbmZpZ3VyYXRpb24gfSBmcm9tICcuL2FuZ3VsYXItZ29vZ2xlLXRhZy1tYW5hZ2VyLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IEdvb2dsZVRhZ01hbmFnZXJDb25maWcgfSBmcm9tICcuL2dvb2dsZS10YWctbWFuYWdlci1jb25maWcnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgR29vZ2xlVGFnTWFuYWdlclNlcnZpY2Uge1xuICBwcml2YXRlIGlzTG9hZGVkID0gZmFsc2U7XG4gIHByaXZhdGUgY29uZmlnOiBHb29nbGVUYWdNYW5hZ2VyQ29uZmlnIHwgbnVsbDtcblxuICBwcml2YXRlIGJyb3dzZXJHbG9iYWxzID0ge1xuICAgIHdpbmRvd1JlZigpOiBhbnkge1xuICAgICAgcmV0dXJuIHdpbmRvdztcbiAgICB9LFxuICAgIGRvY3VtZW50UmVmKCk6IGFueSB7XG4gICAgICByZXR1cm4gZG9jdW1lbnQ7XG4gICAgfSxcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoR29vZ2xlVGFnTWFuYWdlckNvbmZpZ3VyYXRpb24pXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJDb25maWd1cmF0aW9uOiBHb29nbGVUYWdNYW5hZ2VyQ29uZmlndXJhdGlvbixcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KCdnb29nbGVUYWdNYW5hZ2VySWQnKSBwdWJsaWMgZ29vZ2xlVGFnTWFuYWdlcklkOiBzdHJpbmcsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlck1vZGUnKSBwdWJsaWMgZ29vZ2xlVGFnTWFuYWdlck1vZGU6IFwic2lsZW50XCJ8XCJub2lzeVwiID0gXCJub2lzeVwiLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlckF1dGgnKVxuICAgIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VyQXV0aDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlclByZXZpZXcnKVxuICAgIHB1YmxpYyBnb29nbGVUYWdNYW5hZ2VyUHJldmlldzogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnZ29vZ2xlVGFnTWFuYWdlclJlc291cmNlUGF0aCcpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJSZXNvdXJjZVBhdGg6IHN0cmluZyxcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoJ2dvb2dsZVRhZ01hbmFnZXJDU1BOb25jZScpXG4gICAgcHVibGljIGdvb2dsZVRhZ01hbmFnZXJDU1BOb25jZTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMuY29uZmlnID0gdGhpcy5nb29nbGVUYWdNYW5hZ2VyQ29uZmlndXJhdGlvbj8uZ2V0KCk7XG4gICAgaWYgKHRoaXMuY29uZmlnID09IG51bGwpIHtcbiAgICAgIHRoaXMuY29uZmlnID0geyBpZDogbnVsbCB9O1xuICAgIH1cblxuICAgIHRoaXMuY29uZmlnID0ge1xuICAgICAgLi4udGhpcy5jb25maWcsXG4gICAgICBpZDogZ29vZ2xlVGFnTWFuYWdlcklkIHx8IHRoaXMuY29uZmlnLmlkLFxuICAgICAgZ3RtX2F1dGg6IGdvb2dsZVRhZ01hbmFnZXJBdXRoIHx8IHRoaXMuY29uZmlnLmd0bV9hdXRoLFxuICAgICAgZ3RtX3ByZXZpZXc6IGdvb2dsZVRhZ01hbmFnZXJQcmV2aWV3IHx8IHRoaXMuY29uZmlnLmd0bV9wcmV2aWV3LFxuICAgICAgZ3RtX3Jlc291cmNlX3BhdGg6XG4gICAgICAgIGdvb2dsZVRhZ01hbmFnZXJSZXNvdXJjZVBhdGggfHwgdGhpcy5jb25maWcuZ3RtX3Jlc291cmNlX3BhdGgsXG4gICAgfTtcbiAgICBpZiAodGhpcy5jb25maWcuaWQgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tGb3JJZCgpOiBib29sZWFuIHtcbiAgICBpZiggdGhpcy5nb29nbGVUYWdNYW5hZ2VyTW9kZSAhPT0gXCJzaWxlbnRcIiAmJiAhdGhpcy5jb25maWcuaWQgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvb2dsZSB0YWcgbWFuYWdlciBJRCBub3QgcHJvdmlkZWQuJyk7XG4gICAgfSBlbHNlIGlmKCAhdGhpcy5jb25maWcuaWQgKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGdldERhdGFMYXllcigpOiBhbnlbXSB7XG4gICAgdGhpcy5jaGVja0ZvcklkKCk7XG4gICAgY29uc3Qgd2luZG93ID0gdGhpcy5icm93c2VyR2xvYmFscy53aW5kb3dSZWYoKTtcbiAgICB3aW5kb3cuZGF0YUxheWVyID0gd2luZG93LmRhdGFMYXllciB8fCBbXTtcbiAgICByZXR1cm4gd2luZG93LmRhdGFMYXllcjtcbiAgfVxuXG4gIHByaXZhdGUgcHVzaE9uRGF0YUxheWVyKG9iajogb2JqZWN0KTogdm9pZCB7XG4gICAgdGhpcy5jaGVja0ZvcklkKCk7XG4gICAgY29uc3QgZGF0YUxheWVyID0gdGhpcy5nZXREYXRhTGF5ZXIoKTtcbiAgICBkYXRhTGF5ZXIucHVzaChvYmopO1xuICB9XG5cbiAgcHVibGljIGFkZEd0bVRvRG9tKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAodGhpcy5pc0xvYWRlZCkge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZSh0aGlzLmlzTG9hZGVkKTtcbiAgICAgIH0gZWxzZSBpZiggIXRoaXMuY2hlY2tGb3JJZCgpICkge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZShmYWxzZSk7XG4gICAgICB9XG4gICAgICBjb25zdCBkb2MgPSB0aGlzLmJyb3dzZXJHbG9iYWxzLmRvY3VtZW50UmVmKCk7XG4gICAgICB0aGlzLnB1c2hPbkRhdGFMYXllcih7XG4gICAgICAgICdndG0uc3RhcnQnOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcbiAgICAgICAgZXZlbnQ6ICdndG0uanMnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGd0bVNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgIGd0bVNjcmlwdC5pZCA9ICdHVE1zY3JpcHQnO1xuICAgICAgZ3RtU2NyaXB0LmFzeW5jID0gdHJ1ZTtcbiAgICAgIGd0bVNjcmlwdC5zcmMgPSB0aGlzLmFwcGx5R3RtUXVlcnlQYXJhbXMoXG4gICAgICAgIHRoaXMuY29uZmlnLmd0bV9yZXNvdXJjZV9wYXRoXG4gICAgICAgICAgPyB0aGlzLmNvbmZpZy5ndG1fcmVzb3VyY2VfcGF0aFxuICAgICAgICAgIDogJ2h0dHBzOi8vd3d3Lmdvb2dsZXRhZ21hbmFnZXIuY29tL2d0bS5qcydcbiAgICAgICk7XG4gICAgICBndG1TY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoKHRoaXMuaXNMb2FkZWQgPSB0cnVlKSk7XG4gICAgICB9KTtcbiAgICAgIGd0bVNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChmYWxzZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLmdvb2dsZVRhZ01hbmFnZXJDU1BOb25jZSkge1xuICAgICAgICBndG1TY3JpcHQuc2V0QXR0cmlidXRlKCdub25jZScsIHRoaXMuZ29vZ2xlVGFnTWFuYWdlckNTUE5vbmNlKTtcbiAgICAgIH1cbiAgICAgIGRvYy5oZWFkLmluc2VydEJlZm9yZShndG1TY3JpcHQsIGRvYy5oZWFkLmZpcnN0Q2hpbGQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHB1c2hUYWcoaXRlbTogb2JqZWN0KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmKCAhdGhpcy5jaGVja0ZvcklkKCkgKSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5pc0xvYWRlZCkge1xuICAgICAgICB0aGlzLmFkZEd0bVRvRG9tKClcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnB1c2hPbkRhdGFMYXllcihpdGVtKTtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goKCkgPT4gcmVqZWN0KCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5wdXNoT25EYXRhTGF5ZXIoaXRlbSk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFwcGx5R3RtUXVlcnlQYXJhbXModXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh1cmwuaW5kZXhPZignPycpID09PSAtMSkge1xuICAgICAgdXJsICs9ICc/JztcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgdXJsICtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuY29uZmlnKVxuICAgICAgICAuZmlsdGVyKChrKSA9PiB0aGlzLmNvbmZpZ1trXSlcbiAgICAgICAgLm1hcCgoaykgPT4gYCR7a309JHt0aGlzLmNvbmZpZ1trXX1gKVxuICAgICAgICAuam9pbignJicpXG4gICAgKTtcbiAgfVxufVxuIl19